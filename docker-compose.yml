services:

  # NOTE: MQTT Broker is provided by host mosquitto on port 1883
  # Do NOT start a separate mosquitto container in production
  # Services connect via host.docker.internal:1883 (Linux) or host.docker.internal:1883 (Docker Desktop)

  # ╔══════════════════════════════════════╗
  # ║                  PSQL                ║
  # ╚══════════════════════════════════════╝
  postgresql:
    image: postgres:14-alpine
    container_name: PostgreSQL
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: FL
      POSTGRES_USER: program
      POSTGRES_PASSWORD: program
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./Database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ╔══════════════════════════════════════╗
  # ║                 FastAPI              ║
  # ╚══════════════════════════════════════╝
  server_api:
    build: ./Serveur_API
    container_name: Server_API
    restart: on-failure
    ports:
      - "8000:8000"
    depends_on:
      postgresql:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - type: bind
        source: /home/WebFL/FL
        target: /app/FL
    environment:
      POSTGRES_HOST: postgresql
      POSTGRES_DB: FL
      POSTGRES_USER: program
      POSTGRES_PASSWORD: program
      MQTT_HOST: host.docker.internal
      MQTT_PORT: "1883"

  # ╔══════════════════════════════════════╗
  # ║            Sensor Ingestor           ║
  # ╚══════════════════════════════════════╝
  sensor_ingestor:
    build: ./Sensor_Ingestor
    container_name: Sensor_Ingestor
    restart: on-failure
    depends_on:
      postgresql:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      MQTT_HOST: host.docker.internal
      MQTT_PORT: "1883"
      DB_HOST: postgresql
      DB_NAME: FL
      DB_USER: program
      DB_PASS: program
      BATCH_SIZE: "200"
      BATCH_FLUSH_SECS: "1.0"

  # ╔══════════════════════════════════════╗
  # ║              Automation              ║
  # ╚══════════════════════════════════════╝
  automation:
    build: ./Automation
    container_name: Automation_Service
    restart: on-failure
    depends_on:
      postgresql:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      MQTT_HOST: host.docker.internal
      MQTT_PORT: "1883"
      SENSOR_TOPIC: "Data"
      LIGHT_SENSOR_NAME: "light"
      LAMP_ID: "lamp1"
      TH_LOW: "200"
      TH_HIGH: "300"
      DUR_ON_SECS: "5"
      DUR_OFF_SECS: "5"

  # ╔══════════════════════════════════════╗
  # ║             Client Python            ║
  # ╚══════════════════════════════════════╝
  client_server:
    build: ./Serveur_Client
    container_name: Client_Server
    restart: on-failure
    depends_on:
      server_api:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - type: bind
        source: /home/WebFL/FL
        target: /app/FL
    environment:
      MQTT_BROKER_HOST: host.docker.internal
      MQTT_HOST: host.docker.internal
      MQTT_PORT: "1883"

  # ╔══════════════════════════════════════╗
  # ║             vue.js website           ║
  # ╚══════════════════════════════════════╝
  vue_frontend:
    build: ./Site_Vue
    container_name: vue_app
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - server_api

volumes:
  postgres_data:
    driver: local
  # mosquitto_data:
  #   driver: local
  # mosquitto_log:
  #   driver: local
